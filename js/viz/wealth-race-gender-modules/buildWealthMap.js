define(["d3","underscore","leaflet","../../tools/mapFactory","../../tools/barChartFactory"],function(t,e,n,a,r){return function(n,o,i){var u=function(){return a({id:o,center:[39.215,-96.789],zoom:5,g:!1})},l=function(n,a){var r=t.map();return e.each(n,function(t){r.set(t.geo.id,t[a].total)}),r},c=function(e){var n=t.max(e,function(t){return t.incomeData.total}),a=t.min(e,function(t){return t.incomeData.total}),r=Math.round((n-a)/5);return t.range(a,n,r)},s=function(e,n){return t.scale.ordinal().domain(e).range(n)},f=function(n,a){var i=r({width:.36*n.w,height:.6*n.h,"class":"barChart",el:"#"+o+"-bar"}),u=function(){var t={};return e.each(a,function(n){t[n.geo.id]=e.pluck(n.incomeData.subPops,"value")}),t},l=function(){var n=[];return e.each(i.data,function(e){n.push(t.max(e))}),t.max(n)};return $("#"+o+"-bar").parent().height(n.h),i.data=u(),i.max=l(i.data),i.titles=e.pluck(a[0].incomeData.subPops,"title"),i.view=i.svg.selectAll("rect"),i.scale=i.setLinearScale([0,i.max],[0,i.h-60]),i},d=function(t,e){var n=t.view.data(e).enter().append("rect").attr({width:function(){return t.w/e.length-4},y:function(e){return t.h-t.scale(e)-20},x:function(n,a){return 0===a?t.w/e.length*a+2:t.w/e.length*a},"class":function(e,n){return t.titles[n]}});return setTimeout(function(){n.attr("height",function(e){return"undefined"==typeof e?0:t.scale(e)}),t.svg.selectAll(".wealth text").data(e).enter().append("text").text(function(t){if(null===t)return"";var e=t.toString();return"$"+e.slice(0,-3)+","+e.slice(-3)}).attr({x:function(n,a){return a*(t.w/e.length)+6},y:function(e){return t.h-t.scale(e)-24},"class":"wealth","font-size":"18px",fill:"#222"}),t.svg.selectAll(".race text").data(e).enter().append("text").text(function(e,n){return t.titles[n]}).attr({x:function(n,a){var r=t.titles[a].length>5?2:14;return a*(t.w/e.length)+r},y:function(){return t.h-2},"class":"race","font-size":"18px",fill:"#003366"})},100)};return t.json("../../data/wealth-gender-race/json/county-"+n+".json",function(e,n){e&&console.warn(e);var a=t.rgb(i),r=c(n),o=u();return o.medianTotalWealthMap=l(n,"incomeData"),o.medianTotalPopMap=l(n,"popData"),o.setCountyFillOpacity=s(r,t.range(.5,1.1,.1)),o.setCountyColor=s(r,[a.brighter(1.5),a.brighter(1),a.brighter(.5),a.darker(.5),a.darker(1),a.darker(1.5)]),o.bar=f(o,n),o.renderData=function(){o.states.attr("d",o.path),o.counties.attr({d:o.path,fill:function(t){return o.setCountyColor(o.medianTotalWealthMap.get(t.id))},"fill-opacity":function(t){return o.setCountyFillOpacity(o.medianTotalWealthMap.get(t.id))}}).on("mouseover",function(t){var e=o.bar.data[t.id];o.bar.write=d(o.bar,e)}).on("mouseout",function(){clearTimeout(o.bar.write),o.bar.svg.selectAll("rect").transition().ease("linear").attr("height",0).attr("y",o.bar.h).remove(),o.bar.svg.selectAll("text").remove()}).append("title").text(function(t){return o.medianTotalPopMap.get(t.id)})},o.addUSLeafletOverlay({states:"path",county:"path",onReady:function(){o.reset(o.renderData)}}),o.view.on("viewreset",function(){o.reset(o.renderData)}),o})}});