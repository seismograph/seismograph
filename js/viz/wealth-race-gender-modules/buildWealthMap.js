define(["d3","underscore","leaflet","../../tools/mapFactory","../../tools/barChartFactory"],function(t,e,r,n,a){return function(r,i,o){var u=function(){var t=n({id:i,center:[39.215,-96.789],zoom:5,g:!1});return $("#"+i).parent().height(t.h),t},l=function(r,n,a){var i=e.map(r,function(t){return Object.byString(t,a)});if(e.isArray(i[0])){var o=0;return e.each(i,function(e){var r=t[n](e);r>o&&(o=r)}),o}return t[n](i)},s=function(e,r){return t.scale.ordinal().domain(e).range(r)},c=function(t){var e=a({width:.36*t.w,height:.6*t.h,"class":"barChart",el:"#"+i+"-bar"});return $("#"+i+"-bar").css("top",-1*((t.h-e.h)/2+e.h)),e},d=function(t,e){if(!t)return!1;var r=this,n=r.view.data(t).enter().append("rect").attr({width:function(){return r.w/t.length-4},y:function(t){return r.h-r.scale(t)-20},x:function(e,n){return 0===n?r.w/t.length*n+2:r.w/t.length*n},"class":function(t,e){return r.titles[e]}});return setTimeout(function(){n.attr("height",function(t,n){return e[n]<500?0:r.scale(t)}),r.svg.selectAll(".wealth text").data(t).enter().append("text").text(function(t,r){if(null===t||e[r]<500)return"";var n=t.toString();return"$"+n.slice(0,-3)+","+n.slice(-3)}).attr({x:function(e,n){return n*(r.w/t.length)+6},y:function(t){return r.h-r.scale(t)-24},"class":"wealth","font-size":"18px",fill:"#222"})},100)};return t.json("../../data/wealth-gender-race/json/county-"+r+".json",function(e,r){e&&console.warn(e);var n=r["0"];delete r["0"];var a=u(),i=t.rgb(o),h=function(){var e=l(r,"max","incomeData.total"),a=l(r,"min","incomeData.total"),i=Math.round((e-a)/n.length);return t.range(a,e,i)}();return a.setCountyFillOpacity=s(h,t.range(.5,1.1,.1)),a.setCountyColor=s(h,[i.brighter(1.5),i.brighter(1),i.brighter(.5),i.darker(.5),i.darker(1),i.darker(1.5)]),a.bar=c(a),a.bar.scale=a.bar.setLinearScale([0,l(r,"max","incomeData.subPops")],[0,a.bar.h-60]),a.bar.titles=n,a.bar.view=a.bar.svg.selectAll("rect"),a.bar.renderChart=d,a.renderData=function(){a.bar.svg.selectAll("text.race").data(a.bar.titles).enter().append("text").text(function(t){return t}).attr({x:function(t,e){var r=t.length>5?2:14;return e*(a.bar.w/a.bar.titles.length)+r},y:function(){return a.bar.h-2},"class":"race","font-size":"18px",fill:"#003366"}),a.states.attr("d",a.path),a.counties.attr({d:a.path,fill:function(t){return r[t.id]?a.setCountyColor(r[t.id].incomeData.total):0},"fill-opacity":function(t){return r[t.id]?a.setCountyFillOpacity(r[t.id].incomeData.total):0}}).on("mouseover",function(t){var e=r[t.id]?r[t.id].incomeData.subPops:!1;a.bar.write=a.bar.renderChart(e,r[t.id].popData.subPops)}).on("mouseout",function(){clearTimeout(a.bar.write),a.bar.svg.selectAll("rect").transition().ease("linear").attr("height",0).attr("y",a.bar.h-20).remove(),a.bar.svg.selectAll("text.wealth").remove()}).append("title").text(function(t){if(!r[t.id])return!1;return r[t.id].title+"\nPopulation: "+r[t.id].popData.total+"\n - Black: "+r[t.id].popData.subPops[0]+"\n - Asian: "+r[t.id].popData.subPops[1]+"\n - White: "+r[t.id].popData.subPops[2]+"\n - Hispanic: "+r[t.id].popData.subPops[3]+"\n - Other: "+r[t.id].popData.subPops[4]})},a.addUSLeafletOverlay({states:"path",county:"path",onReady:function(){a.reset(a.renderData)}}),a.view.on("viewreset",function(){a.reset(a.renderData)}),a})}});