define(["d3","underscore","leaflet","../../tools/mapFactory","../../tools/barChartFactory"],function(t,e,r,n,a){return function(r,i,o){var u=function(){var t=n({id:i,center:[39.215,-96.789],zoom:5,g:!1});return $("#"+i).parent().height(t.h),t},c=function(r,n,a){var i=e.map(r,function(t){return Object.byString(t,a)});if(e.isArray(i[0])){var o=0;return e.each(i,function(e){var r=t[n](e);r>o&&(o=r)}),o}return t[n](i)},l=function(e,r){return t.scale.ordinal().domain(e).range(r)},s=function(t){var e=a({width:.36*t.w,height:.6*t.h,"class":"barChart",el:"#"+i+"-bar"});return $("#"+i+"-bar").css("top",-1*((t.h-e.h)/2+e.h)),e},d=function(t){if(!t)return!1;var e=this,r=e.view.data(t).enter().append("rect").attr({width:function(){return e.w/t.length-4},y:function(t){return e.h-e.scale(t)-20},x:function(r,n){return 0===n?e.w/t.length*n+2:e.w/t.length*n},"class":function(t,r){return e.titles[r]}});return setTimeout(function(){r.attr("height",function(t){return e.scale(t)}),e.svg.selectAll(".wealth text").data(t).enter().append("text").text(function(t){if(null===t)return"";var e=t.toString();return"$"+e.slice(0,-3)+","+e.slice(-3)}).attr({x:function(r,n){return n*(e.w/t.length)+6},y:function(t){return e.h-e.scale(t)-24},"class":"wealth","font-size":"18px",fill:"#222"}),e.svg.selectAll(".race text").data(t).enter().append("text").text(function(t,r){return e.titles[r]}).attr({x:function(r,n){var a=e.titles[n].length>5?2:14;return n*(e.w/t.length)+a},y:function(){return e.h-2},"class":"race","font-size":"18px",fill:"#003366"})},100)};return t.json("../../data/wealth-gender-race/json/county-"+r+".json",function(r,n){r&&console.warn(r);var a=n["0"];delete n["0"];var i=u(),f=t.rgb(o),h=function(){var e=c(n,"max","incomeData.total"),r=c(n,"min","incomeData.total"),a=Math.round((e-r)/5);return t.range(r,e,a)}();return i.setCountyFillOpacity=l(h,t.range(.5,1.1,.1)),i.setCountyColor=l(h,[f.brighter(1.5),f.brighter(1),f.brighter(.5),f.darker(.5),f.darker(1),f.darker(1.5)]),i.bar=s(i),i.bar.scale=i.bar.setLinearScale([0,c(n,"max","incomeData.subPops")],[0,i.bar.h-60]),i.bar.titles=a,i.bar.view=i.bar.svg.selectAll("rect"),i.bar.renderChart=d,i.renderData=function(){i.states.attr("d",i.path),i.counties.attr({d:i.path,fill:function(t){return n[t.id]?i.setCountyColor(n[t.id].incomeData.total):0},"fill-opacity":function(t){return n[t.id]?i.setCountyFillOpacity(n[t.id].incomeData.total):0}}).on("mouseover",function(t){var e=n[t.id]?n[t.id].incomeData.subPops:!1;i.bar.write=i.bar.renderChart(e)}).on("mouseout",function(){clearTimeout(i.bar.write),i.bar.svg.selectAll("rect").transition().ease("linear").attr("height",0).attr("y",i.bar.h).remove(),i.bar.svg.selectAll("text").remove()}).append("title").text(function(t){if(!n[t.id])return!1;var r=function(e){return Math.round(e/n[t.id].popData.total*100)+"%"},a=function(){var r=n[t.id].popData.total,a=e.reduce(n[t.id].popData.subPops,function(t,e,r){return 4!==r?t+e:t});return Math.round((r-a)/r*100)+"%"};return n[t.id].title+"\nPopulation: "+n[t.id].popData.total+"\n - Black: "+r(n[t.id].popData.subPops[0])+"\n - Asian: "+r(n[t.id].popData.subPops[1])+"\n - White: "+r(n[t.id].popData.subPops[2])+"\n - Hispanic: "+r(n[t.id].popData.subPops[3])+"\n - Other: "+a()})},i.addUSLeafletOverlay({states:"path",county:"path",onReady:function(){i.reset(i.renderData)}}),i.view.on("viewreset",function(){i.reset(i.renderData)}),i})}});