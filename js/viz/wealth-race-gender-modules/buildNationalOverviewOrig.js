define(["d3","underscore"],function(t,e){return function(s,a){var i=function(e,s){return t.select("#"+a).append("svg").attr({width:e,height:s})},n=function(e){return t.scale.linear().domain([0,e.max]).range([0,.5*e.h])},r=function(t){for(var s=[],a=0;a<t["0"].length;a++)s.push({title:t["0"][a],value:t["1"].incomeData.subPops[a]});tempObj=e.sortBy(s,function(t){return-t.value}),t["0"]=e.pluck(tempObj,"title"),t["1"].incomeData.subPops=e.pluck(tempObj,"value")},h=function(){var e=this.linearScale(t.max(this.data.incomeData.subPops));this.svg.append("line").attr({"class":"base",x1:0,y1:e,x2:this.w/2,y2:e})},c=function(t,e,s,a,i,n){var r=this;rectSize=this.linearScale(e),t.append("rect").attr({"class":a+" "+this.titles[s],x:function(){return r.xBase+="back"===a?.6*rectSize:0,"back"===a?r.xBase-rectSize:r.xBase-rectSize+i},y:function(){return r.yBase+=n,r.yBase-rectSize},width:rectSize,height:rectSize})},u=function(t,e,s,a){var i=this.linearScale(t);switch(e){case"bottom":return[{x:this.xBase-i,y:this.yBase},{x:this.xBase,y:this.yBase},{x:this.xBase+s,y:this.yBase+a},{x:this.xBase-i+s,y:this.yBase+a}];case"right":return[{x:this.xBase,y:this.yBase-i},{x:this.xBase,y:this.yBase},{x:this.xBase+s,y:this.yBase+a},{x:this.xBase+s,y:this.yBase+a-i}];case"top":return[{x:this.xBase-i,y:this.yBase-i},{x:this.xBase,y:this.yBase-i},{x:this.xBase+s,y:this.yBase+a-i},{x:this.xBase-i+s,y:this.yBase+a-i}];case"left":return[{x:this.xBase-i,y:this.yBase-i},{x:this.xBase-i,y:this.yBase},{x:this.xBase+s-i,y:this.yBase+a},{x:this.xBase+s-i,y:this.yBase+a-i}]}},l=function(e,s,a,i,n,r){var h=this.setPathPointMap(s,i,n,r),c=t.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("linear-closed");e.append("path").attr({d:c(h),"class":this.titles[a]})},o=function(){var e=this,s=40,a=15;this.xBase=$(window).width()>1250?140:70,this.yBase=e.linearScale(t.max(e.data.incomeData.subPops)),this.svg.selectAll("g.cubes").data(e.data.incomeData.subPops).enter().append("g").attr("class","cubes").each(function(i,n){var r=t.select(this);e.setRectAttr(r,i,n,"back",s,a),e.setPathAttr(r,i,n,"bottom",s,a),e.setPathAttr(r,i,n,"right",s,a),e.setPathAttr(r,i,n,"top",s,a),e.setPathAttr(r,i,n,"left",s,a),e.setRectAttr(r,i,n,"front",s,a)})},x=function(){var e=this,s=25,a=50;this.svg.selectAll("g.legend").data(this.titles).enter().append("g").attr("class","legend").each(function(i,n){var r=t.select(this);r.append("rect").attr({x:e.w-.35*e.w,y:s+n*(5+a),height:a,width:a,"class":function(t){return t}}),r.append("text").text(function(t){var s=e.data.incomeData.subPops[n].toString();return"â€“ "+t+": $"+s.slice(0,-3)+","+s.slice(-3)}).attr({x:e.w-(.35*e.w-20)+a,y:s+n*(5+a)+(a/2+4),"font-size":"20px",fill:"#222"})})};t.json("../../data/wealth-gender-race/json/us-"+s+".json",function(e){r(e);var s=$("#"+a).width(),d=$(window).width()>1499?Math.round(.3*s):Math.round(.4*s),y={svg:i(s,d),data:e["1"],titles:e["0"],w:s,h:d,buildBase:h,buildCubes:o,setRectAttr:c,setPathAttr:l,setPathPointMap:u,buildLegend:x};y.max=t.max(y.data.incomeData.subPops),y.linearScale=n(y),y.buildBase(),y.buildCubes(),y.buildLegend()})}});