define(["leaflet","../tools/mapFactory"],function(t,e){var r=function(r){var a={id:"sf-bicycle-theft",center:[37.775,-122.444],zoom:13,tile:"http://{s}.tiles.mapbox.com/v3/lukewhyte.i8ahci39/{z}/{x}/{y}.png"},i=e(a);r.json("../../data/sf-bike-theft/bike-crime-geo.json",function(e,a){if(e)return console.warn(e);({prepDataset:function(t){for(var e=0,r=t.length,a={};r>e;e++)"800 Block of BRYANT ST"!==t[e].properties.address?(a[t[e].geometry.coordinates]?a[t[e].geometry.coordinates]+=5:a[t[e].geometry.coordinates]=5,t[e].properties.radius=a[t[e].geometry.coordinates]):t[e].properties.radius=0},mapPointToSvgPath:function(e,r){var a=i.view.latLngToLayerPoint(new t.LatLng(r,e));this.stream.point(a.x,a.y)},formatString:function(t){var t=t.toLowerCase();return t.charAt(0).toUpperCase()+t.slice(1)},formatDate:function(t){var e=new Date(1e3*t);return e.getMonth()+1+"/"+e.getDate()+"/"+e.getFullYear()},formatTime:function(t){var e=parseInt(t.slice(0,t.indexOf(":")));return e>12?e-12+t.slice(t.indexOf(":"))+"pm":e+t.slice(t.indexOf(":"))+"am"},resetMap:function(t,e){var r=this,n=t.bounds(a),o=n[0],s=n[1];t.pointRadius(function(t){var e=i.view.getZoom();return e>16?1.5*t.properties.radius:e>11?t.properties.radius:e>9?t.properties.radius/3:t.properties.radius/6}),i.svg.attr("width",s[0]+10-(o[0]-10)).attr("height",s[1]+10-(o[1]-10)).style("left",o[0]+"px").style("top",o[1]+"px"),i.g.attr("transform","translate("+-o[0]+","+-o[1]+")"),e.attr({d:function(e){return t(e)},"fill-opacity":function(t){return 5===t.properties.radius?.5:t.properties.radius<=10?.35:.25}}).append("title").text(function(t){return"Crime: "+r.formatString(t.properties.crime)+"\nDate: "+r.formatDate(t.properties.date)+", "+r.formatTime(t.properties.time)+"\nAddress: "+r.formatString(t.properties.address)})},timeStolen:function(t){var e=200,a=r.select("#timeStolen").append("svg").attr({width:i.w,height:e}),n=function(){for(var e=0,r=t.length,a=[];r>e;e++){var i=t[e].properties.time.trim(),i=parseInt(i.slice(0,i.indexOf(":")));a[i]?a[i]+=1:a[i]=1}return a}(),o="12am,1am,2am,3am,4am,5am,6am,7am,8am,9am,10am,11am,12pm,1pm,2pm,3pm,4pm,5pm,6pm,7pm,8pm,9pm,10pm,11pm".split(",");max=r.max(n),yRange=r.scale.linear().domain([0,max]).range([0,e-30]),oRange=r.scale.linear().domain([0,max]).range([.4,1]),bWidth=i.w/n.length,hourRange=r.scale.ordinal().domain(o).rangePoints([bWidth/2+2,i.w-(bWidth/2+2)]),xAxis=r.svg.axis().scale(hourRange).orient("bottom").tickValues(hourRange.domain()),a.selectAll("rect").data(n).enter().append("rect").attr({width:function(){return bWidth-4},height:function(t){return yRange(t)},y:function(t){return e-yRange(t)},x:function(t,e){return bWidth*e},"fill-opacity":function(t){return oRange(t)}}),a.append("g").attr("class","axis").call(xAxis)},init:function(){var t,e,n,o=this;o.prepDataset(a.features),t=r.geo.transform({point:o.mapPointToSvgPath}),e=r.geo.path().projection(t),n=i.g.selectAll("path").data(a.features.sort(function(t,e){return e.properties.radius-t.properties.radius})).enter().append("path"),i.view.on("viewreset",function(){o.resetMap(e,n)}),o.resetMap(e,n),o.timeStolen(a.features)}}).init()})};return r});